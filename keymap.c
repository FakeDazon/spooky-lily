#include QMK_KEYBOARD_H
#include <stdio.h>

// OLED setup
#define IDLE_FRAMES 5
#define IDLE_SPEED 30
#define TAP_FRAMES 2
#define TAP_SPEED 20
#define ANIM_FRAME_DURATION 200
#define ANIM_SIZE 512

#define GENERIC_MAX(x, y) ((x) > (y) ? (x) : (y))

#define ENSURE_int(i)   _Generic((i), int:   (i))
#define ENSURE_float(f) _Generic((f), float: (f))


#define MAX(type, x, y) \
  (type)GENERIC_MAX(ENSURE_##type(x), ENSURE_##type(y))

bool gui_on = true;
char wpm_str[10];
uint32_t anim_timer = 0;
uint32_t anim_sleep = 0;
uint8_t current_idle_frame = 0;
uint8_t current_tap_frame = 0;

// RGB underglow timeout setup
static long int oled_timeout = 600000; // 10 minutes

//
// Keymaps
//
const uint16_t PROGMEM keymaps[][MATRIX_ROWS][MATRIX_COLS] = {

    // Layer 0 (default)
    [0] = LAYOUT(
    KC_ESC,            KC_1,       KC_2,       KC_3,       KC_4,       KC_5,                                       KC_6,       KC_7,       KC_8,       KC_9,       KC_0,       KC_BSPC,
    KC_TAB,             KC_Q,       KC_W,       KC_E,       KC_R,       KC_T,                                       KC_Y,       KC_U,       KC_I,       KC_O,       KC_P,       KC_BSLASH,
    KC_LCTRL,             KC_A,       KC_S,       KC_D,       KC_F,       KC_G,                                       KC_H,       KC_J,       KC_K,       KC_L,       KC_SCLN,    KC_QUOT,
    KC_LSFT,    KC_Z,       KC_X,       KC_C,       KC_V,       KC_B,       KC_LBRC,            KC_RBRC,    KC_N,       KC_M,       KC_COMM,    KC_DOT,     KC_SLSH,    KC_RSFT,
                                                KC_LGUI,    KC_LALT,    TT(2),    KC_ENT,          KC_SPC,     TT(1),    KC_RCTRL,      TT(3)
    ),

    // Layer 1 (lower)
    [2] = LAYOUT(
    KC_GRV,              _______,      _______,      _______,      _______,      _______,                                      _______,      _______,      _______,      _______,     _______,     _______,
    KC_F1,              KC_F2,      KC_F3,      KC_F4,      KC_F5,      KC_F6,                                      KC_F7,      KC_F8,      KC_F9,      KC_F10,     KC_F11,     KC_F12,
    KC_GRV,            KC_EXLM,    KC_AT,    KC_HASH,    KC_DLR,    KC_PERC,                                    KC_CIRC,     KC_AMPR,    KC_ASTR,    KC_LPRN,      KC_RPRN,    KC_TILD,
    _______,            _______,    _______,    _______,    _______,    _______,    _______,             _______,    XXXXXXX,    KC_UNDS,     KC_PLUS,    KC_LCBR,    KC_RCBR,    KC_PIPE,
                                                _______,    _______,    _______,    _______,             _______,    _______,    _______,    _______
    ),
    // Layer 2 (raise)
    [1] = LAYOUT(
    KC_GRV,              KC_1,      KC_2,      KC_3,      KC_4,      KC_5,                                      KC_6,      KC_7,      KC_8,      KC_9,     KC_0,     _______,
    KC_GRV,             KC_AUDIO_MUTE,    KC_MPRV,      KC_MEDIA_PLAY_PAUSE,    KC_MNXT,    _______,                                    _______,    _______,    _______,    KC_UP,    _______,    KC_DEL,
    KC_F1,            KC_F2,    KC_F3,    KC_F4,    KC_F5,    KC_F6,                                    _______,     _______,    KC_LEFT,    KC_DOWN,      KC_RGHT,    _______,
    KC_F7,            KC_F8,    KC_F9,    KC_F10,    KC_F11,    KC_F12,    KC_AUDIO_VOL_DOWN,             KC_AUDIO_VOL_UP,    KC_PLUS,    KC_MINS,     KC_EQL,    KC_LBRC,    KC_RBRC,    KC_BSLS,
                                                _______,    _______,    _______,    _______,             _______,    _______,    _______,    _______
    ),
    // Layer 3 (gamer)
    [3] = LAYOUT(
    KC_ESC,    KC_1,      KC_2,      KC_3,      KC_4,      KC_5,                                              KC_6,      KC_7,      KC_8,      KC_9,     KC_0,     _______,  
    KC_TAB,             KC_Q,       KC_W,       KC_E,       KC_R,       KC_T,                                    KC_F1,    KC_F2,    KC_F3,    KC_F4,    KC_F5,    _______,
    KC_LCTRL,            KC_A,       KC_S,       KC_D,       KC_F,       KC_G,                                     KC_F6,     KC_F7,    KC_F8,    KC_F9,      KC_F10,    _______,
    KC_LSFT,            KC_Z,       KC_X,       KC_C,       KC_V,       KC_B,       KC_LBRC,             _______,    KC_PLUS,    KC_MINS,     KC_EQL,    KC_LBRC,    KC_RBRC,    KC_BSLS,
                                                _______,    _______,    _______,    KC_SPC,             _______,    _______,    _______,    _______
    ),

};

//
// Keyboard initialization
//
void keyboard_post_init_user(void) {
    // Wait for keyboard startup
    wait_ms(100);
}



//
// Key processing
//
bool process_record_user(uint16_t keycode, keyrecord_t *record) {

    // Get GUI keys status
    switch (keycode) {
        // GUI keys disabled
        case GUI_OFF:
            if (record -> event.pressed) gui_on = false;
            break;
        // GUI keys enabled
        case GUI_ON:
            if (record -> event.pressed) gui_on = true;
            break;
    }
    
    return true;
}


//
// Rotate OLED display
//
oled_rotation_t oled_init_user(oled_rotation_t rotation) {
	if (!is_keyboard_master()) return OLED_ROTATION_180;
    else return rotation;
}

//
// Render left OLED display
//
static void render_status(void) {
    
    // WPM
    oled_write_P(PSTR("      "), false);
    sprintf(wpm_str, "%03d", get_current_wpm());
    oled_write(wpm_str, false);
    oled_write_P(PSTR("   WPM"), false);

    // GUI keys indicator
    if (gui_on) oled_write_P(PSTR("\n       "), false);
    else oled_write_P(PSTR("\n      GUI   OFF"), false);
    
    // Layer indicator
    oled_write_P(PSTR("\n      LAYER "), false);
    switch (get_highest_layer(layer_state)) {
        // Layer 2
        case 2:
            oled_write_P(PSTR("  2"), false);
            break;
        // Layer 1
        case 1:
            oled_write_P(PSTR("  1"), false);
            break;
        // Layer 3
        case 3:
            oled_write_P(PSTR("  G"), false);
            break;
        // Layer 0
        default:
            oled_write_P(PSTR("  0"), false);
            break;
    }

}

//
// Render right OLED display animation
//
static void render_anim(void) {

    // Idle animation
    static const char PROGMEM idle[IDLE_FRAMES][ANIM_SIZE] = {

        {
        3, 31,231, 27, 22, 38,202,202, 50, 26, 23, 36, 68,196,245,142,132,132,  8,239, 24,  8,  8,  8,  8,144, 81, 54, 24,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,192, 38, 38,158, 78, 76, 36, 36, 36, 34, 18, 18, 18, 20, 24,  8,  8,  4,  4,  4,  8, 48, 64,128,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,128,128,128,128,  0,  0,  0,  0,  0,  0,  0,  0,  0,128,128,128,128,  0,  0, 
        0,130, 66, 66, 71,122,193, 32, 16, 17, 14,  8, 22, 33, 64,128,224, 24,  4,  3,  3,  2,130, 68, 36, 24, 27, 12,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 24,100,130,  2,  2,  2,  2,  3,  1,  0,  0,  0,  0,192,192,  0,  0,  0,128,  0,  0,128,128,128,224,  0, 24, 24,  0,192,193,193,194,  4,  8, 16, 32, 64,128,  0,  0,  0,128,128,128,128, 64, 64, 64, 64, 32, 32, 32, 32,  0,240, 12,  2,  1,  0,  0, 16,206,193,193,  2,  2,  2,  2,  2,193,193,206, 16,  0,  0,  1,  2,
        12, 32, 16, 16, 16, 16, 33, 46,112,152,  4,  2,  1,129, 65, 65, 33, 34, 36, 40, 48, 14,  1,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,192, 56,  4,  3,  0,  0,  0,  0,  0,  0,  0, 12, 12, 12, 12,  0,  0, 64,160, 33, 39, 17, 16, 16, 16, 11,  8,  8,  8,  8,  4,  4,  8,  8, 16, 16, 16, 16, 16, 17, 15,  1,  1,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 63,192,  0,  0,  0,  0, 28,225,  1, 17, 48, 32, 32, 32, 48, 17,  1,225, 28,  0,  0,  0, 
        0,192,  4,  2,  2,  2,  2,  2,  2,  4,  7, 12,  6,  1,  0,  0,  0,  0,  0,128,128,128,128,128, 64, 64, 64, 64, 64, 32, 32, 32, 32, 32, 16, 16, 16, 16, 16,  8,  8,  8,  8,  8,  4,  4,  4,  4,  4,  2,  3,  2,  2,  1,  1,  1,  1,  1,  1,  2,  2,  4,  4,  8,  8,  8,  8,  8,  7,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  1,  2,  4,  4,  4,  5,  2,  4,  8,  8,  8,  8,  8,  4,  2,  5,  4,  4,  4,  2, 
        1,  0,
    },
{
        3, 31,231, 27, 22, 38,202,202, 50, 26, 23, 36, 68,196,245,142,132,132,  8,239, 24,  8,  8,  8,  8,144, 81, 54, 24,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,192, 38, 38,158, 78, 76, 36, 36, 36, 34, 18, 18, 18, 20, 24,  8,  8,  4,  4,  4,  8, 48, 64,128,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,128,128,128,128,  0,  0,  0,  0,  0,  0,  0,  0,  0,128,128,128,128,  0,  0, 
        0,130, 66, 66, 71,122,193, 32, 16, 17, 14,  8, 22, 33, 64,128,224, 24,  4,  3,  3,  2,130, 68, 36, 24, 27, 12,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 24,100,130,  2,  2,  2,  2,  3,  1,  0,  0,  0,  0,192,192,  0,  0,  0,128,  0,  0,128,128,128,224,  0, 24, 24,  0,192,193,193,194,  4,  8, 16, 32, 64,128,  0,  0,  0,128,128,128,128, 64, 64, 64, 64, 32, 32, 32, 32,  0,240, 12,  2,  1,  0,  0, 16,206,193,193,  2,  2,  2,  2,  2,193,193,206, 16,  0,  0,  1,  2,
        12, 32, 16, 16, 16, 16, 33, 46,112,152,  4,  2,  1,129, 65, 65, 33, 34, 36, 40, 48, 14,  1,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,192, 56,  4,  3,  0,  0,  0,  0,  0,  0,  0, 12, 12, 12, 12,  0,  0, 64,160, 33, 39, 17, 16, 16, 16, 11,  8,  8,  8,  8,  4,  4,  8,  8, 16, 16, 16, 16, 16, 17, 15,  1,  1,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 63,192,  0,  0,  0,  0, 28,225,  1, 17, 48, 32, 32, 32, 48, 17,  1,225, 28,  0,  0,  0, 
        0,192,  4,  2,  2,  2,  2,  2,  2,  4,  7, 12,  6,  1,  0,  0,  0,  0,  0,128,128,128,128,128, 64, 64, 64, 64, 64, 32, 32, 32, 32, 32, 16, 16, 16, 16, 16,  8,  8,  8,  8,  8,  4,  4,  4,  4,  4,  2,  3,  2,  2,  1,  1,  1,  1,  1,  1,  2,  2,  4,  4,  8,  8,  8,  8,  8,  7,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  1,  2,  4,  4,  4,  5,  2,  4,  8,  8,  8,  8,  8,  4,  2,  5,  4,  4,  4,  2, 
        1,  0,
    },

        {
        3, 31,231, 27, 22, 38,202,202, 50, 26, 23, 36, 68,196,245,142,132,132,  8,239, 24,  8,  8,  8,  8,144, 81, 54, 24,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,128, 76, 76, 60,156,152, 72, 72, 72, 68, 36, 36, 36, 40, 16,  8,  4,  2,  2,  4, 24, 96,128,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,128,128,128,128,  0,  0,  0,  0,  0,  0,  0,  0,  0,128,128,128,128,  0,  0, 
        0,130, 66, 66, 71,122,193, 32, 16, 17, 14,  8, 22, 33, 64,128,224, 24,  4,  3,  3,  2,130, 68, 36, 24, 27, 12,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 60,194,  1,  1,  2,  2,  5,  6,  2,  1,  0,  0,  0,128,128,  0,  0,  0,  0,  0,  0,  0,  0,  0,128,  0, 48, 48,  0,193,194,194,196,  8, 16, 32, 64,128,  0,  0,  0,  0,128,128,128,128, 64, 64, 64, 64, 32, 32, 32, 32,  0,240, 12,  2,  1,  0,  0, 16,206,193,193,  2,  2,  2,  2,  2,193,193,206, 16,  0,  0,  1,  2,
        12, 32, 16, 16, 16, 16, 33, 46,112,152,  4,  2,  1,129, 65, 65, 33, 34, 36, 40, 48, 14,  1,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,128,112, 25,  6,  0,  0,  0,  0,  0,  0,  0, 12, 12, 12, 13,  1,  0, 64,160, 33, 38, 18, 17, 17, 17, 11,  8,  8,  8,  8,  4,  4,  8,  8, 16, 16, 16, 16, 16, 17, 15,  1,  1,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 63,192,  0,  0,  0,  0, 28,225,  1, 17, 48, 32, 32, 32, 48, 17,  1,225, 28,  0,  0,  0, 
        0,192,  4,  2,  2,  2,  2,  2,  2,  4,  7, 12,  6,  1,  0,  0,  0,  0,  0,128,128,128,128,128, 64, 64, 64, 64, 64, 32, 32, 32, 32, 32, 16, 16, 16, 16, 16,  8,  8,  8,  8,  8,  4,  4,  4,  4,  4,  2,  3,  2,  2,  1,  1,  1,  1,  1,  1,  2,  2,  4,  4,  8,  8,  8,  8,  8,  7,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  1,  2,  4,  4,  4,  5,  2,  4,  8,  8,  8,  8,  8,  4,  2,  5,  4,  4,  4,  2, 
        1,  0,
    },

        {
        3, 31,231, 27, 22, 38,202,202, 50, 26, 23, 36, 68,196,245,142,132,132,  8,239, 24,  8,  8,  8,  8,144, 81, 54, 24,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,128,128,  0,  0,192, 38, 38,158, 78, 76, 36, 36, 36, 34, 18, 18, 18, 20,  8,  4,  2,  1,  1,  2, 12, 48, 64,128,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,128,128,128,128,  0,  0,  0,  0,  0,  0,  0,  0,  0,128,128,128,128,  0,  0, 
        0,130, 66, 66, 71,122,193, 32, 16, 17, 14,  8, 22, 33, 64,128,224, 24,  4,  3,  3,  2,130, 68, 36, 24, 27, 12,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 30,225,  0,  0,  1,  1,  2,  3,  1,  0,  0,  0,  0,192,192,  0,  0,  0,128,  0,  0,128,128,128,192,  0, 24, 24,  0, 96, 97, 97, 98,  4,  8, 16, 32, 64,128,  0,  0,  0,128,128,128,128, 64, 64, 64, 64, 32, 32, 32, 32,  0,240, 12,  2,  1,  0,  0, 16,206,193,193,  2,  2,  2,  2,  2,193,193,206, 16,  0,  0,  1,  2,
        12, 32, 16, 16, 16, 16, 33, 46,112,152,  4,  2,  1,129, 65, 65, 33, 34, 36, 40, 48, 14,  1,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,128,112, 12,  3,  0,  0,  0,  0,  0,  0,  0, 12, 12, 12, 12,  0,  0, 64,160, 32, 39, 17, 16, 16, 16, 11,  8,  8,  8,  8,  4,  4,  8,  8, 16, 16, 16, 16, 16, 17, 15,  1,  1,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 63,192,  0,  0,  0,  0, 28,225,  1, 17, 48, 32, 32, 32, 48, 17,  1,225, 28,  0,  0,  0, 
        0,192,  4,  2,  2,  2,  2,  2,  2,  4,  7, 12,  6,  1,  0,  0,  0,  0,  0,128,128,128,128,128, 64, 64, 64, 64, 64, 32, 32, 32, 32, 32, 16, 16, 16, 16, 16,  8,  8,  8,  8,  8,  4,  4,  4,  4,  4,  2,  3,  2,  2,  1,  1,  1,  1,  1,  1,  2,  2,  4,  4,  8,  8,  8,  8,  8,  7,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  1,  2,  4,  4,  4,  5,  2,  4,  8,  8,  8,  8,  8,  4,  2,  5,  4,  4,  4,  2, 
        1,  0,
    },

        {
        3, 31,231, 27, 22, 38,202,202, 50, 26, 23, 36, 68,196,245,142,132,132,  8,239, 24,  8,  8,  8,  8,144, 81, 54, 24,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,192, 38, 38,158, 78, 76, 36, 36, 36, 34, 18, 18, 18, 20,  8,  8,  4,  2,  2,  2,  4, 56, 64,128,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,128,128,128,128,  0,  0,  0,  0,  0,  0,  0,  0,  0,128,128,128,128,  0,  0, 
        0,130, 66, 66, 71,122,193, 32, 16, 17, 14,  8, 22, 33, 64,128,224, 24,  4,  3,  3,  2,130, 68, 36, 24, 27, 12,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 28,226,  1,  1,  2,  2,  2,  3,  1,  0,  0,  0,  0,192,192,  0,  0,  0,128,  0,  0,128,128,128,192,  0, 24, 24,  0,224,225,225,226,  4,  8, 16, 32, 64,128,  0,  0,  0,128,128,128,128, 64, 64, 64, 64, 32, 32, 32, 32,  0,240, 12,  2,  1,  0,  0, 16,206,193,193,  2,  2,  2,  2,  2,193,193,206, 16,  0,  0,  1,  2,
        12, 32, 16, 16, 16, 16, 33, 46,112,152,  4,  2,  1,129, 65, 65, 33, 34, 36, 40, 48, 14,  1,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,128,112, 12,  3,  0,  0,  0,  0,  0,  0,  0, 12, 12, 12, 12,  0,  0, 64,160, 32, 39, 17, 16, 16, 16, 11,  8,  8,  8,  8,  4,  4,  8,  8, 16, 16, 16, 16, 16, 17, 15,  1,  1,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 63,192,  0,  0,  0,  0, 28,225,  1, 17, 48, 32, 32, 32, 48, 17,  1,225, 28,  0,  0,  0, 
        0,192,  4,  2,  2,  2,  2,  2,  2,  4,  7, 12,  6,  1,  0,  0,  0,  0,  0,128,128,128,128,128, 64, 64, 64, 64, 64, 32, 32, 32, 32, 32, 16, 16, 16, 16, 16,  8,  8,  8,  8,  8,  4,  4,  4,  4,  4,  2,  3,  2,  2,  1,  1,  1,  1,  1,  1,  2,  2,  4,  4,  8,  8,  8,  8,  8,  7,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  1,  2,  4,  4,  4,  5,  2,  4,  8,  8,  8,  8,  8,  4,  2,  5,  4,  4,  4,  2, 
        1,  0,
    }

    };

    // Prep animation
    static const char PROGMEM prep[][ANIM_SIZE] = {

        {
        3, 31,231, 27, 22, 38,202,202, 50, 26, 23, 36, 68,196,245,142,132,132,  8,239, 24,  8,  8,  8,  8,144, 81, 54, 24,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,128,128,  0,  0,192, 38, 38,158, 78, 76, 36, 36, 36, 34, 18, 18, 18, 20,  8,  4,  2,  1,  1,  2, 12, 48, 64,128,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,128,128,128,128,  0,  0,  0,  0,  0,  0,  0,  0,  0,128,128,128,128,  0,  0, 
        0,130, 66, 66, 71,122,193, 32, 16, 17, 14,  8, 22, 33, 64,128,224, 24,  4,  3,  3,  2,130, 68, 36, 24, 27, 12,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 30,225,  0,  0,  1,  1,  2,  3,129,128,128,  0, 16,208,192,  0,  0,  0,128,  0,  0,128,128,128,192,  0, 26, 25,  0,  0,  1,225, 26,  6,  9, 49, 53,  1,138,124,  0,  0,128,128,128,128, 64, 64, 64, 64, 32, 32, 32, 32,  0,240, 12,  2,  1,  0,  0, 16,206,193,129,  2,  2,  2,  2,  2,129,193,206, 16,  0,  0,  1,  2,
        12, 32, 16, 16, 16, 16, 33, 46,112,152,  4,  2,  1,129, 65, 65, 33, 34, 36, 40, 48, 14,  1,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,128,112, 12,  3,  0,  0, 24,  6,  5,152,153,132,195,124, 64, 64, 64, 64, 32, 32, 39, 17, 16, 16, 16, 11,  8,  8,  8,  8,  4,  4,  4,  4,  4,  4,  2,  2,  2,  1,  1,  1,  1,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 63,192,  0,  0,  0,  0, 28,193, 25, 49, 48, 96, 96, 96, 48, 49, 25,193, 28,  0,  0,  0, 
        0,192,  4,  2,  2,  2,  2,  2,  2,  4,  7, 12,  6,  1,  0,  0,  0,  0,  0,128,128,128,128,128, 64, 64, 64, 64, 64, 32, 32, 32, 32, 32, 16, 16, 16, 16, 16,  8,  8,  8,  8,  8,  4,  4,  4,  4,  4,  2,  3,  2,  2,  1,  1,  1,  1,  1,  1,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  1,  2,  4,  4,  4,  5,  2,  4,  8,  8,  8,  8,  8,  4,  2,  5,  4,  4,  4,  2, 
        1,  0,
    }

    };

    // Typing animation
    static const char PROGMEM tap[TAP_FRAMES][ANIM_SIZE] = {

        {
        3, 31,231, 27, 22, 38,202,202, 50, 26, 23, 36, 68,196,245,142,132,132,  8,239, 24,  8,  8,  8,  8,144, 81, 54, 24,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,128,128,  0,  0,192, 38, 38,158, 78, 76, 36, 36, 36, 34, 18, 18, 18, 20,  8,  4,  2,  1,  1,  2, 12, 48, 64,128,  0,  0,  0,  0,  0,  0,248,200,200,200,200,120,  0,  0,  0,  0,128,128,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,128,128,128,128,  0,  0,  0,  0,  0,  0,  0,  0,  0,128,128,128,128,  0,  0, 
        0,130, 66, 66, 71,122,193, 32, 16, 17, 14,  8, 22, 33, 64,128,224, 24,  4,  3,  3,  2,130, 68, 36, 24, 27, 12,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 30,225,  0,  0,  1,  1,  2,  3,129,128,128,  0,  8,200,208, 16,  0,  0,128,  0,  0,128,128,128,196,  2, 25, 24,  0,  0,  1,  1,  2,  4,  8, 16, 32, 67,132,  6,  1,  0,184,164,166,159, 92, 88, 75, 76, 32, 32, 32, 32,  0,240, 12,  2,  1,  0,  0, 16,206,129,  1,  2,  2,  2,  2,  2,  1,129,206, 16,  0,  0,  1,  2,
        12, 32, 16, 16, 16, 16, 33, 46,112,152,  4,  2,  1,129, 65, 65, 33, 34, 36, 40, 48, 14,  1,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,128,112, 12,  3,  0,  0, 24,  6,  5,152,153,132, 67,124, 64, 64, 64, 64, 32, 32, 39, 17, 16, 16, 16, 11,  8,  8,  8,  8,  4,  4,  8,  8, 16, 16, 16, 16, 16, 17, 15,  1, 57, 68,196,244,124, 28,196, 52, 12,  0,  0,  0,  0,  0, 63,192,  0,  0,  0,  0,  0,157, 57,113, 96, 96, 96, 96, 96,113, 57,157,  0,  0,  0,  0, 
        0,192,  4,  2,  2,  2,  2,  2,  2,  4,  7, 12,  6,  1,  0,  0,  0,  0,  0,128,128,128,128,128, 64, 64, 64, 64, 64, 32, 32, 32, 32, 32, 16, 16, 16, 16, 16,  8,  8,  8,  8,  8,  4,  4,  4,  4,  4,  2,  3,  2,  2,  1,  1,  1,  1,  1,  1,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  1,  2,  3,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  1,  2,  4,  4,  4,  5,  2,  4,  8,  8,  8,  8,  8,  4,  2,  5,  4,  4,  4,  2, 
        1,  0,
    },

        {
        3, 31,231, 27, 22, 38,202,202, 50, 26, 23, 36, 68,196,245,142,132,132,  8,239, 24,  8,  8,  8,  8,144, 81, 54, 24,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,128,128,  0,  0,192, 38, 38,158, 78, 76, 36, 36, 36, 34, 18, 18, 18, 20,  8,  4,  2,  1,  1,  2, 12, 48, 64,128,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,128,128,128,128,  0,  0,  0,  0,  0,  0,  0,  0,  0,128,128,128,128,  0,  0, 
        0,130, 66, 66, 71,122,193, 32, 16, 17, 14,  8, 22, 33, 64,128,224, 24,  4,  3,  3,  2,130, 68, 36, 24, 27, 12,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 30,225,  0,  0,  1,  1,  2,  3,  1,  0,  0,  0,  8,200,208, 16,  0,  0,128,  0,  0,128,128,128,196,  2, 25, 24,  0,  0,  1,225, 26,  6,  9, 49, 53,  1,138,124,  0,  0,128,128,128,128, 64, 64, 64, 64, 32, 32, 32, 32,  0,240, 12,  2,  1,  0,  0, 16,206,129,  1,  2,  2,  2,  2,  2,  1,129,206, 16,  0,  0,  1,  2,
        12, 32, 16, 16, 16, 16, 33, 46,112,152,  4,  2,  1,129, 65, 65, 33, 34, 36, 40, 48, 14,  1,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,128,112, 12,  3,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 64,160, 32, 39, 17, 16, 16, 16, 11,  8,  8,  8,  8,  4,  4,  4,  4,  4,  4,  2,  2,  2,  1,  1,  1,  1,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 63,192,  0,  0,  0,  0,  0,157, 57,113, 96, 96, 96, 96, 96,113, 57,157,  0,  0,  0,  0, 
        0,192,  4,  2,  2,  2,  2,  2,  2,  4,  7, 12,  6,  1,  0,  0,  0,  0,  0,128,128,128,128,128, 64, 64, 64, 64, 64, 32, 32, 32, 32, 32, 16, 16, 16, 16, 16,  8,  8,  8,  8,  8,  4,  4,  4,  4,  4,  2,  3,114,138,137,249,249,137, 81, 49,  2,  2,  4,  4,  8,  8,  8,136,136,135,128,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  1,  2,  4,  4,  4,  5,  2,  4,  8,  8,  8,  8,  8,  4,  2,  5,  4,  4,  4,  2, 
        1,  0,
    }

    };

    void animation_phase(void) {

        if (get_current_wpm() <=IDLE_SPEED) {
            current_idle_frame = (current_idle_frame + 1) % IDLE_FRAMES;
            oled_write_raw_P(idle[abs((IDLE_FRAMES-1)-current_idle_frame)], ANIM_SIZE);
        }

        if (get_current_wpm() >IDLE_SPEED && get_current_wpm() <TAP_SPEED) {
            oled_write_raw_P(prep[0], ANIM_SIZE);
        }

        if (get_current_wpm() >=TAP_SPEED) {
            current_tap_frame = (current_tap_frame + 1) % TAP_FRAMES;
            oled_write_raw_P(tap[abs((TAP_FRAMES-1)-current_tap_frame)], ANIM_SIZE);
        }
    }

    if (get_current_wpm() != 000) {
        oled_on();

        if (timer_elapsed32(anim_timer) > MAX(int, 20, 200 - get_current_wpm())) {
            anim_timer = timer_read32();
            animation_phase();
        }

        anim_sleep = timer_read32();
    } else {
        if (timer_elapsed32(anim_sleep) > oled_timeout) {
            oled_off();
        } else {
            if (timer_elapsed32(anim_timer) > MAX(int, 20, 200 - get_current_wpm())) {
                anim_timer = timer_read32();
                animation_phase();
            }
        }
    }
}

//
// OLED display rendering
//
void oled_task_user(void) {
    if (is_keyboard_master()) {
        // Left side
        render_status();
    } else {
        // Right side
        render_anim();
    }
}